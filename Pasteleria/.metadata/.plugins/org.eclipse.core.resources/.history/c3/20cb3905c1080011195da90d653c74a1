package com.example.demo.serviceimpl;

import com.example.demo.entity.DetallePedido;
import com.example.demo.entity.Pedido;
import com.example.demo.repository.DetallePedidoRepository;
import com.example.demo.repository.PedidoRepository;
import com.example.demo.service.DetallePedidoService;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.util.List;

@Service
public class DetallePedidoServiceImpl implements DetallePedidoService {

    @Autowired
    private DetallePedidoRepository detallePedidoRepository;

    @Autowired
    private PedidoRepository pedidoRepository;

    @Override
    public DetallePedido guardarDetalle(DetallePedido detalle) {

        BigDecimal subtotal = detalle.getPrecioUnitario()
                .multiply(BigDecimal.valueOf(detalle.getCantidad()));
        detalle.setSubtotal(subtotal);

        Pedido pedidoBD = pedidoRepository.findById(detalle.getPedido().getId())
                .orElseThrow(() -> new RuntimeException("Pedido no encontrado"));

        double totalActual = pedidoBD.getPrecioTotal() != null ? pedidoBD.getPrecioTotal() : 0.0;
        double nuevoTotal = totalActual + subtotal.doubleValue();
        pedidoBD.setPrecioTotal(nuevoTotal);

        pedidoRepository.save(pedidoBD);

        detalle.setPedido(pedidoBD);

        return detallePedidoRepository.save(detalle);
    }

    @Override
    public List<DetallePedido> listarDetalles() {
        return detallePedidoRepository.findAll();
    }
}
