package com.example.demo.serviceimpl;

import com.example.demo.dto.DetallePedidoDTO;
import com.example.demo.dto.PedidoDTO;
import com.example.demo.entity.*;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.*;
import com.example.demo.service.PedidoService;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional; 

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Service
public class PedidoServiceImpl implements PedidoService {

    @Autowired private PedidoRepository pedidoRepository;
    @Autowired private ClienteRepository clienteRepository;
    @Autowired private ProductoRepository productoRepository;
    @Autowired private DetallePedidoRepository detallePedidoRepository;

    @Override
    public List<Pedido> listarPedidos() {
        return pedidoRepository.findAll();
    }

    @Override
    public Pedido buscarPorId(Integer id) {
        return pedidoRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("Pedido con ID " + id + " no encontrado"));
    }

    @Override
    @Transactional 
    public Pedido guardarPedido(PedidoDTO dto) {

        Cliente cliente = clienteRepository.findById(dto.getClienteId())
                .orElseThrow(() -> new ResourceNotFoundException("No se puede crear el pedido: El cliente con ID " + dto.getClienteId() + " no existe."));

        Pedido pedido = new Pedido();
        pedido.setFechaPedido(LocalDateTime.now());
        pedido.setFechaRecogida(dto.getFechaRecogida());
        pedido.setEstado(dto.getEstado());
        pedido.setObservaciones(dto.getObservaciones());
        pedido.setCliente(cliente);
        pedido.setPrecioTotal(0.0); 

        final Pedido pedidoGuardado = pedidoRepository.save(pedido);

        BigDecimal totalAcumulado = BigDecimal.ZERO;
        List<DetallePedido> detalles = new ArrayList<>();

        if (dto.getDetalles() != null) {
            for (DetallePedidoDTO d : dto.getDetalles()) {
                Producto producto = productoRepository.findById(d.getProductoId())
                        .orElseThrow(() -> new ResourceNotFoundException("Error en el detalle: El producto con ID " + d.getProductoId() + " no existe."));

                DetallePedido detalle = new DetallePedido();
                detalle.setPedido(pedidoGuardado);
                detalle.setProducto(producto);
                detalle.setCantidad(d.getCantidad());
                detalle.setPrecioUnitario(d.getPrecioUnitario());
                
                BigDecimal subtotal = d.getPrecioUnitario()
                        .multiply(BigDecimal.valueOf(d.getCantidad()));

                detalle.setSubtotal(subtotal);
                totalAcumulado = totalAcumulado.add(subtotal);

                detalles.add(detalle);
            }
            detallePedidoRepository.saveAll(detalles);
        }

        pedidoGuardado.setPrecioTotal(totalAcumulado.doubleValue());
        return pedidoRepository.save(pedidoGuardado);
    }
}